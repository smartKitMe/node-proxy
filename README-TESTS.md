# Node Proxy æµ‹è¯•å¥—ä»¶

æœ¬æ–‡æ¡£ä»‹ç» Node Proxy é¡¹ç›®çš„å®Œæ•´æµ‹è¯•å¥—ä»¶ï¼ŒåŒ…æ‹¬æµ‹è¯•ç»“æ„ã€è¿è¡Œæ–¹æ³•å’Œæµ‹è¯•è¦†ç›–èŒƒå›´ã€‚

## ğŸ“ æµ‹è¯•ç»“æ„

```
test/
â”œâ”€â”€ setup.js                           # æµ‹è¯•ç¯å¢ƒè®¾ç½®
â”œâ”€â”€ mocha.opts                         # Mocha é…ç½®æ–‡ä»¶
â”œâ”€â”€ test-runner.js                     # æµ‹è¯•è¿è¡Œå™¨
â”œâ”€â”€ unit/                              # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ basic-proxy.test.js           # åŸºç¡€ä»£ç†åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ middleware-system.test.js     # ä¸­é—´ä»¶ç³»ç»Ÿæµ‹è¯•
â”‚   â”œâ”€â”€ interceptor-system.test.js    # æ‹¦æˆªå™¨ç³»ç»Ÿæµ‹è¯•
â”‚   â”œâ”€â”€ websocket-proxy.test.js       # WebSocketä»£ç†æµ‹è¯•
â”‚   â””â”€â”€ certificate-management.test.js # è¯ä¹¦ç®¡ç†æµ‹è¯•
â”œâ”€â”€ integration/                       # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ integration.test.js           # ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•
â””â”€â”€ performance/                       # æ€§èƒ½æµ‹è¯•
    â””â”€â”€ performance-monitoring.test.js # æ€§èƒ½ç›‘æ§æµ‹è¯•
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
npm install
```

### è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# ä½¿ç”¨ npm è„šæœ¬
npm test

# æˆ–ä½¿ç”¨æµ‹è¯•è¿è¡Œå™¨
node test/test-runner.js
```

### è¿è¡Œç‰¹å®šç±»å‹çš„æµ‹è¯•

```bash
# åªè¿è¡Œå•å…ƒæµ‹è¯•
node test/test-runner.js unit

# åªè¿è¡Œé›†æˆæµ‹è¯•
node test/test-runner.js integration

# åªè¿è¡Œæ€§èƒ½æµ‹è¯•
node test/test-runner.js performance
```

### è¿è¡Œç‰¹å®šçš„æµ‹è¯•æ–‡ä»¶

```bash
# è¿è¡ŒåŒ…å« 'basic' çš„æµ‹è¯•
node test/test-runner.js --specific basic

# è¿è¡Œä¸­é—´ä»¶ç›¸å…³æµ‹è¯•
node test/test-runner.js --specific middleware

# è¿è¡ŒWebSocketç›¸å…³æµ‹è¯•
node test/test-runner.js --specific websocket
```

## ğŸ“‹ æµ‹è¯•ç”¨ä¾‹è¦†ç›–

### å•å…ƒæµ‹è¯• (Unit Tests)

#### 1. åŸºç¡€ä»£ç†åŠŸèƒ½æµ‹è¯• (`basic-proxy.test.js`)
- **TC-BASIC-001**: åŸºç¡€HTTPä»£ç†åŠŸèƒ½
- **TC-BASIC-002**: é»˜è®¤é…ç½®å¯åŠ¨æµ‹è¯•
- **TC-BASIC-003**: æœåŠ¡å™¨ä¿¡æ¯è·å–æµ‹è¯•
- **TC-BASIC-004**: å¤šç«¯å£é…ç½®æµ‹è¯•
- **TC-BASIC-005**: ä»£ç†æœåŠ¡å™¨åœæ­¢æµ‹è¯•

#### 2. ä¸­é—´ä»¶ç³»ç»Ÿæµ‹è¯• (`middleware-system.test.js`)
- **TC-MW-001**: ä¸­é—´ä»¶æ³¨å†Œå’Œæ‰§è¡Œæµ‹è¯•
- **TC-MW-002**: ä¸­é—´ä»¶ä¼˜å…ˆçº§æµ‹è¯•
- **TC-MW-003**: å¼‚æ­¥ä¸­é—´ä»¶å¤„ç†æµ‹è¯•
- **TC-MW-004**: ä¸­é—´ä»¶é”™è¯¯å¤„ç†æµ‹è¯•
- **TC-MW-005**: æ¡ä»¶ä¸­é—´ä»¶æ‰§è¡Œæµ‹è¯•

#### 3. æ‹¦æˆªå™¨ç³»ç»Ÿæµ‹è¯• (`interceptor-system.test.js`)
- **TC-INT-001**: è¯·æ±‚æ‹¦æˆªå’Œä¿®æ”¹æµ‹è¯•
- **TC-INT-002**: å“åº”æ‹¦æˆªå’Œä¿®æ”¹æµ‹è¯•
- **TC-INT-003**: æ‹¦æˆªå™¨é“¾æµ‹è¯•
- **TC-INT-004**: æ¡ä»¶æ‹¦æˆªå™¨æµ‹è¯•

#### 4. WebSocketä»£ç†æµ‹è¯• (`websocket-proxy.test.js`)
- **TC-WS-001**: åŸºç¡€WebSocketè¿æ¥æµ‹è¯•
- **TC-WS-002**: å¹¶å‘WebSocketè¿æ¥æµ‹è¯•
- **TC-WS-003**: WebSocketè¿æ¥æ‹¦æˆªæµ‹è¯•
- **TC-WS-004**: WebSocketæ¶ˆæ¯æ‹¦æˆªå’Œé”™è¯¯å¤„ç†æµ‹è¯•

#### 5. è¯ä¹¦ç®¡ç†æµ‹è¯• (`certificate-management.test.js`)
- **TC-CERT-001**: å›ºå®šè¯ä¹¦é…ç½®æµ‹è¯•
- **TC-CERT-002**: åŠ¨æ€è¯ä¹¦ç”Ÿæˆæµ‹è¯•
- **TC-CERT-003**: è¯ä¹¦éªŒè¯æµ‹è¯•
- **TC-CERT-004**: HTTPSä»£ç†åŠŸèƒ½æµ‹è¯•

### é›†æˆæµ‹è¯• (Integration Tests)

#### é›†æˆæµ‹è¯• (`integration.test.js`)
- **TC-INT-001**: å®Œæ•´ä»£ç†æµç¨‹é›†æˆæµ‹è¯•
  - HTTP APIè¯·æ±‚å¤„ç†
  - HTTPSå®‰å…¨è¯·æ±‚å¤„ç†
  - WebSocketä»£ç†æ”¯æŒ
  - é™æ€æ–‡ä»¶æœåŠ¡
  - æ€§èƒ½ç›‘æ§é›†æˆ
- **TC-INT-002**: å¤šç»„ä»¶ååŒæµ‹è¯•
  - ä¸­é—´ä»¶å’Œæ‹¦æˆªå™¨åè°ƒ
  - å¤æ‚è¯·æ±‚è·¯ç”±
- **TC-INT-003**: çœŸå®åœºæ™¯æ¨¡æ‹Ÿæµ‹è¯•
  - é«˜å¹¶å‘è¯·æ±‚å¤„ç†
  - é•¿æ—¶é—´è¿æ¥ç»´æŠ¤

### æ€§èƒ½æµ‹è¯• (Performance Tests)

#### æ€§èƒ½ç›‘æ§æµ‹è¯• (`performance-monitoring.test.js`)
- **TC-PERF-001**: åŸºç¡€æ€§èƒ½æŒ‡æ ‡æ”¶é›†æµ‹è¯•
  - è¯·æ±‚è®¡æ•°ã€å“åº”æ—¶é—´ã€ååé‡
  - é”™è¯¯ç‡ã€è¿æ¥æ•°ã€èµ„æºä½¿ç”¨
  - æ€§èƒ½å†å²æ•°æ®ç®¡ç†
- **TC-PERF-002**: æ€§èƒ½æŠ¥å‘Šç”Ÿæˆæµ‹è¯•
  - è¯¦ç»†æ€§èƒ½æŠ¥å‘Š
  - è¶‹åŠ¿åˆ†æ
  - ä¼˜åŒ–å»ºè®®ç”Ÿæˆ
- **TC-PERF-003**: è´Ÿè½½æµ‹è¯•
  - é«˜å¹¶å‘æ€§èƒ½æŒ‡æ ‡æ”¶é›†
  - å†…å­˜ç®¡ç†éªŒè¯
- **TC-PERF-004**: æ€§èƒ½é˜ˆå€¼ç›‘æ§
  - æ€§èƒ½å¼‚å¸¸æ£€æµ‹
  - é˜ˆå€¼å‘Šè­¦

## âš™ï¸ æµ‹è¯•é…ç½®

### ç¯å¢ƒè¦æ±‚
- Node.js >= 12.0.0
- æµ‹è¯•ç«¯å£èŒƒå›´ï¼š
  - ä»£ç†ç«¯å£: 18000-18099
  - ç›®æ ‡æœåŠ¡å™¨ç«¯å£: 19000-19099
  - WebSocketç«¯å£: 20000-20099

### æµ‹è¯•é…ç½® (`setup.js`)
- å…¨å±€æµ‹è¯•ç¯å¢ƒè®¾ç½®
- ç«¯å£ç®¡ç†å™¨ï¼ˆé¿å…ç«¯å£å†²çªï¼‰
- æµ‹è¯•å·¥å…·å‡½æ•°
- æ€§èƒ½æµ‹è¯•é…ç½®

### Mocha é…ç½® (`mocha.opts`)
- æµ‹è¯•è¶…æ—¶æ—¶é—´: 30ç§’
- æŠ¥å‘Šæ ¼å¼: spec
- é€’å½’æµ‹è¯•æ–‡ä»¶æŸ¥æ‰¾
- é¢œè‰²è¾“å‡ºæ”¯æŒ

## ğŸ”§ æµ‹è¯•è¿è¡Œå™¨åŠŸèƒ½

æµ‹è¯•è¿è¡Œå™¨ (`test-runner.js`) æä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

### åŸºæœ¬ç”¨æ³•
```bash
node test/test-runner.js [é€‰é¡¹] [æµ‹è¯•æ¨¡å¼]
```

### é€‰é¡¹
- `--help, -h`: æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
- `--specific <pattern>`: è¿è¡ŒåŒ¹é…æŒ‡å®šæ¨¡å¼çš„æµ‹è¯•

### æµ‹è¯•æ¨¡å¼
- `all`: è¿è¡Œæ‰€æœ‰æµ‹è¯•ï¼ˆé»˜è®¤ï¼‰
- `unit`: åªè¿è¡Œå•å…ƒæµ‹è¯•
- `integration`: åªè¿è¡Œé›†æˆæµ‹è¯•
- `performance`: åªè¿è¡Œæ€§èƒ½æµ‹è¯•

### åŠŸèƒ½ç‰¹æ€§
- ğŸ¯ æ™ºèƒ½æµ‹è¯•æ–‡ä»¶åŒ¹é…
- ğŸ“Š è¯¦ç»†çš„æµ‹è¯•ç»“æœç»Ÿè®¡
- â±ï¸ æµ‹è¯•æ‰§è¡Œæ—¶é—´ç»Ÿè®¡
- ğŸ” å¤±è´¥æµ‹è¯•çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
- ğŸ“ˆ æµ‹è¯•æˆåŠŸç‡è®¡ç®—

## ğŸ“Š æµ‹è¯•æŠ¥å‘Š

æµ‹è¯•è¿è¡Œåä¼šæ˜¾ç¤ºè¯¦ç»†çš„æµ‹è¯•ç»“æœæ‘˜è¦ï¼š

```
ğŸ“Š æµ‹è¯•ç»“æœæ‘˜è¦
============================================================
æ€»æµ‹è¯•æ–‡ä»¶: 8
âœ… é€šè¿‡: 7
âŒ å¤±è´¥: 1
âš ï¸  è·³è¿‡: 0
â±ï¸  è€—æ—¶: 45.32s
ğŸ“ˆ æˆåŠŸç‡: 87.5%
```

## ğŸ› è°ƒè¯•æµ‹è¯•

### è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶
```bash
npx mocha test/unit/basic-proxy.test.js --timeout 30000
```

### å¯ç”¨è¯¦ç»†æ—¥å¿—
```bash
LOG_LEVEL=debug node test/test-runner.js
```

### è°ƒè¯•ç‰¹å®šæµ‹è¯•ç”¨ä¾‹
```bash
npx mocha test/unit/basic-proxy.test.js --grep "åº”è¯¥æˆåŠŸå¯åŠ¨HTTPä»£ç†æœåŠ¡å™¨"
```

## ğŸ“ ç¼–å†™æ–°æµ‹è¯•

### æµ‹è¯•æ–‡ä»¶ç»“æ„
```javascript
describe('æµ‹è¯•æ¨¡å—åç§°', function() {
    this.timeout(TEST_CONFIG.timeouts.medium);
    
    beforeEach(async function() {
        // æµ‹è¯•å‰å‡†å¤‡
    });
    
    afterEach(async function() {
        // æµ‹è¯•åæ¸…ç†
    });
    
    describe('TC-XXX-001: æµ‹è¯•ç”¨ä¾‹åç§°', function() {
        it('åº”è¯¥æ»¡è¶³ç‰¹å®šæ¡ä»¶', async function() {
            // æµ‹è¯•å®ç°
            expect(result).to.equal(expected);
        });
    });
});
```

### ä½¿ç”¨æµ‹è¯•å·¥å…·
```javascript
// è·å–å¯ç”¨ç«¯å£
const port = portManager.getAvailablePort('proxy');

// ç­‰å¾…å¼‚æ­¥æ“ä½œ
await TestUtils.delay(1000);

// ç­‰å¾…æ¡ä»¶æ»¡è¶³
await TestUtils.waitFor(() => server.listening, 5000);

// åˆ›å»ºæµ‹è¯•æœåŠ¡å™¨
const server = await TestUtils.createTestServer(port, handler);
```

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actions é…ç½®ç¤ºä¾‹
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: '14'
      - run: npm install
      - run: npm test
```

### æµ‹è¯•è¦†ç›–ç‡
```bash
# å®‰è£…è¦†ç›–ç‡å·¥å…·
npm install --save-dev nyc

# è¿è¡Œè¦†ç›–ç‡æµ‹è¯•
npx nyc node test/test-runner.js
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æµ‹è¯•ç”¨ä¾‹æ–‡æ¡£](./docs/) - è¯¦ç»†çš„æµ‹è¯•ç”¨ä¾‹è§„èŒƒ
- [API æ–‡æ¡£](./docs/api.md) - ä»£ç†æœåŠ¡å™¨ API å‚è€ƒ
- [é…ç½®æŒ‡å—](./docs/configuration.md) - é…ç½®é€‰é¡¹è¯´æ˜

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œè¯·åŒæ—¶æ·»åŠ ç›¸åº”çš„æµ‹è¯•ç”¨ä¾‹
2. ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†æäº¤ä»£ç 
3. æµ‹è¯•ç”¨ä¾‹åº”è¯¥è¦†ç›–æ­£å¸¸æµç¨‹å’Œå¼‚å¸¸æƒ…å†µ
4. éµå¾ªç°æœ‰çš„æµ‹è¯•ä»£ç é£æ ¼å’Œå‘½åè§„èŒƒ

## â“ å¸¸è§é—®é¢˜

### Q: æµ‹è¯•è¿è¡Œæ—¶ç«¯å£å†²çªæ€ä¹ˆåŠï¼Ÿ
A: æµ‹è¯•å¥—ä»¶ä½¿ç”¨ç«¯å£ç®¡ç†å™¨è‡ªåŠ¨åˆ†é…ç«¯å£ï¼Œé¿å…å†²çªã€‚å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç«¯å£èŒƒå›´é…ç½®ã€‚

### Q: æŸäº›æµ‹è¯•å¶å°”å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A: å¯èƒ½æ˜¯æ—¶åºé—®é¢˜ï¼Œå°è¯•å¢åŠ æµ‹è¯•è¶…æ—¶æ—¶é—´æˆ–æ·»åŠ é€‚å½“çš„ç­‰å¾…ã€‚

### Q: å¦‚ä½•è·³è¿‡æŸäº›æµ‹è¯•ï¼Ÿ
A: ä½¿ç”¨ `describe.skip()` æˆ– `it.skip()` è·³è¿‡ç‰¹å®šæµ‹è¯•ã€‚

### Q: å¦‚ä½•æ·»åŠ æ–°çš„æµ‹è¯•ç±»å‹ï¼Ÿ
A: åœ¨ç›¸åº”ç›®å½•ä¸‹åˆ›å»ºæµ‹è¯•æ–‡ä»¶ï¼Œå¹¶æ›´æ–°æµ‹è¯•è¿è¡Œå™¨çš„é…ç½®ã€‚